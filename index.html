<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coastal Population Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: url('dark_pacific.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
    }
    .tooltip {
      position: absolute;
      padding: 6px;
      background: white;
      border: 1px solid #999;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      color: black;
    }
    .map-circle {
      fill: lightblue;
      stroke: steelblue;
      stroke-width: 1;
      opacity: 0.5;
    }
    .island-core {
      fill: white;
      stroke: none;
    }
    .toggle-switch {
      margin: 20px;
      color: white;
      font-size: 16px;
      display: flex;
      align-items: center;
    }
    .toggle-switch input {
      display: none;
    }
    .slider {
      width: 50px;
      height: 25px;
      background-color: #ccc;
      border-radius: 25px;
      position: relative;
      margin-left: 10px;
      cursor: pointer;
    }
    .slider::before {
      content: "";
      position: absolute;
      width: 21px;
      height: 21px;
      background-color: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: 0.3s;
    }
    .slider.checked {
      background-color: #4caf50;
    }
    .slider.checked::before {
      transform: translateX(25px);
    }
    .cylinder {
      stroke: #333;
      stroke-width: 0.5;
    }
    .main-panel {
      width: 75%;
      position: relative;
    }
    .side-panel {
      width: 25%;
      padding: 20px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    .side-panel h1, .side-panel h2, .side-panel p {
      color: #000;
    }
  </style>
</head>
<body>
<div class="main-panel">
  <label class="toggle-switch">
    Show Low-Elevation Population
    <div class="slider" id="customToggle"></div>
  </label>
  <svg width="900" height="600"></svg>
  <div class="tooltip" style="opacity:0;"></div>
</div>
<div class="side-panel">
  <h1 id="panel-title">Coastal and Elevation Risk</h1>
  <h2 id="panel-subtitle">Interactive Population View</h2>
  <p id="panel-text">This dashboard visualizes population data near coastlines and in low-elevation zones for key countries. Use the toggle to switch between circular coastal zones and elevation-based stacked bars to understand geographic vulnerability to sea level rise and flooding.</p>
</div>

<!-- Skipping unchanged <head> and <style> for brevity, they remain as in the previous message -->

<script>
const svg = d3.select("svg");
const tooltip = d3.select(".tooltip");
const panelTitle = document.getElementById("panel-title");
const panelSubtitle = document.getElementById("panel-subtitle");
const panelText = document.getElementById("panel-text");
const customToggle = document.getElementById("customToggle");

const zoom = d3.zoom()
  .scaleExtent([1, 8])
  .on("zoom", (event) => svg.selectAll("g.chart-layer").attr("transform", event.transform));
svg.call(zoom);

const chartLayer = svg.append("g").attr("class", "chart-layer");

const projection = d3.geoMercator()
  .center([160, -9])
  .scale(600)
  .translate([450, 300]);

const radius = 60;
const bandColors = ["#dff0ea", "#96cfba", "#26b76f"];

const countryCodeMap = {
  "American Samoa": "as",
  "Cook Islands": "ck",
  "Fiji": "fj",
  "French Polynesia": "pf",
  "Guam": "gu",
  "Netherlands": "nl",
  "Indonesia": "id"
};

function localGovBar(d) {
  const val = +d.local_gov_action_perc;
  if (isNaN(val)) {
    return `<div style="margin-top:5px;">Local Gov Action: <em>No Data Available</em></div>`;
  } else {
    return `
      <div style="margin-top:5px;">Local Gov Action:</div>
      <div style="display:flex;align-items:center;">
        <div style="width: 100px; background: #ccc; height: 10px; margin-right: 5px;">
          <div style="width: ${val.toFixed(1)}%; height: 10px; background: gray;"></div>
        </div>
        <span>${val.toFixed(1)}%</span>
      </div>
    `;
  }
}

function drawCoastal(data) {
  chartLayer.selectAll("*").remove();
  data.forEach((d) => {
    const [x, y] = projection([+d.Longitude, +d.Latitude]);
    [["10km", "10km_abs", "10km_rel"], ["5km", "5km_abs", "5km_rel"], ["1km", "1km_abs", "1km_rel"]].forEach(([label, absKey, relKey], j) => {
      chartLayer.append("circle")
        .attr("cx", x)
        .attr("cy", y)
        .attr("r", radius - j * 15)
        .attr("fill", bandColors[j])
        .attr("opacity", 0.5)
        .on("mouseover", function (event) {
          tooltip.transition().duration(200).style("opacity", 0.9);
          tooltip.html(`
            <strong>${d.Country}</strong><br>${label} from coast:<br>
            ${(+d[absKey]).toLocaleString()} people<br>
            <div style="display:flex;align-items:center;">
              <div style="width: 100px; background: #ccc; height: 10px; margin-right: 5px;">
                <div style="width: ${(+d[relKey]).toFixed(1)}%; height: 10px; background: gray;"></div>
              </div>
              <span>${(+d[relKey]).toFixed(1)}%</span>
            </div>
            ${localGovBar(d)}
          `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));
    });
    chartLayer.append("circle").attr("cx", x).attr("cy", y).attr("r", 3).attr("class", "island-core");
 //   const isoCode = countryCodeMap[d.Country];
//    if (isoCode) {
//      chartLayer.append("image")
//        .attr("x", x - 10).attr("y", y - 10).attr("width", 20).attr("height", 20)
//        .attr("href", `https://flagcdn.com/w40/${isoCode}.png`).attr("clip-path", "circle(10px)");
    }
    chartLayer.append("text")
      .attr("x", x).attr("y", y + 75).attr("text-anchor", "middle")
      .attr("font-size", "12px").attr("fill", "white").text(d.Country);
  });
}

function drawElevation(data) {
  chartLayer.selectAll("*").remove();
  data.forEach((d) => {
    const [x, y] = projection([+d.Longitude, +d.Latitude]);
    let stackHeight = 0;
    const bands = [["5M", "5M_N", "5M_PERCENT"], ["10M", "10M_N", "10M_PERCENT"], ["20M", "20M_N", "20M_PERCENT"]];
    bands.forEach(([label, absKey, relKey], j) => {
      const percent = +d[relKey];
      const height = percent * 0.5;
      const width = 30;
      chartLayer.append("rect")
        .attr("x", x - width / 2).attr("y", y - stackHeight - height)
        .attr("width", width).attr("height", height).attr("fill", bandColors[j])
        .attr("class", "cylinder")
        .on("mouseover", function (event) {
          tooltip.transition().duration(200).style("opacity", 0.9);
          tooltip.html(`
            <strong>${d.Country}</strong><br>${label} elevation:<br>
            ${(+d[absKey]).toLocaleString()} people<br>
            <div style="display:flex;align-items:center;">
              <div style="width: 100px; background: #ccc; height: 10px; margin-right: 5px;">
                <div style="width: ${percent.toFixed(1)}%; height: 10px; background: gray;"></div>
              </div>
              <span>${percent.toFixed(1)}%</span>
            </div>
            ${localGovBar(d)}
          `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));
      stackHeight += height;
    });
    chartLayer.append("text")
      .attr("x", x).attr("y", y + 10).attr("text-anchor", "middle")
      .attr("font-size", "12px").attr("fill", "white").text(d.Country);
  });
}

d3.csv("final_data.csv").then(data => {
  drawCoastal(data);
  customToggle.addEventListener("click", function () {
    customToggle.classList.toggle("checked");
    const isChecked = customToggle.classList.contains("checked");
    if (isChecked) {
      drawElevation(data);
      panelTitle.textContent = "Population in Low-Elevation Zones";
      panelSubtitle.textContent = "Stacked Risk by Altitude";
      panelText.textContent = "This mode shows how many people live below 5m, 10m, and 20m elevation bands. These groups are vulnerable to storm surges, coastal erosion, and sea-level rise.";
    } else {
      drawCoastal(data);
      panelTitle.textContent = "Coastal and Elevation Risk";
      panelSubtitle.textContent = "Interactive Population View";
      panelText.textContent = "This dashboard visualizes population data near coastlines and in low-elevation zones for key countries. Use the toggle to switch between circular coastal zones and elevation-based stacked bars to understand geographic vulnerability to sea level rise and flooding.";
    }
  });
});
</script>
</body>
</html>
